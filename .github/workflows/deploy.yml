name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  FASTAPI_DIR: /home/ubuntu/testfast
  VENV_DIR: /home/ubuntu/testfast/venv
  FASTAPI_PORT: 8000

jobs:
  deploy_and_test:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy & Test via Bastion
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BASTION_IP }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "=== Bastion → FastAPI Deploy ==="

          # Bastion에서 FastAPI 서버로 SSH 접속
          ssh -i ~/.ssh/02T-powermvp.pem ubuntu@${{ secrets.FASTAPI_PRIVATE_IP }} "set -e &&
            cd ${FASTAPI_DIR} &&
            echo '1. Git pull' &&
            git pull origin main &&
            echo '2. Activate venv' &&
            source venv/bin/activate &&
            echo '3. Install requirements' &&
            pip install -r requirements.txt &&
            echo '4. Restart FastAPI' &&
            sudo systemctl restart fastapi &&
            sleep 3 &&
            echo '5. Local FastAPI health check' &&
            curl -f http://127.0.0.1:${FASTAPI_PORT}
          "

          echo "=== FastAPI OK ==="

          echo "=== Nginx → FastAPI Test ==="
          curl -f http://${{ secrets.FASTAPI_PRIVATE_IP }}:${FASTAPI_PORT}

          echo "=== Domain Health Check ==="
          curl -f https://popori.store/health
